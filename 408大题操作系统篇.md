# 408大题操作系统篇
## 要求
* 每题吃透，反复横跳

## 文件系统的实现（物理结构） 16 danger
![img](https://s1.ax1x.com/2020/10/31/BU76bT.jpg)
### 解析
* 第一问
    * 文件目录表
    dir目录文件

    文件名|起始块号
    --|--|
    dir1|48

    dir1目录文件

    文件名|起始块号|
    --|--|
    file1|100
    file2|200
    * 文件分配表FAT

    盘块号|下一块|
    --|--|
    100|106|
    106|108|
    108|-1
    200|201|
    201|202|
    202|-1

* 第三问
    * 106存放在100的表项内，108存放在106的表项内
* 第四问
    * dir已经读入内存，下一步访问dir1，故访问的簇号为48，接着访问file1，一簇为4096B，访问5000B，在file1的第二个簇中，故访问的簇号为106
### 知识点背诵
* 图解文件系统结构
  <img src="https://s1.ax1x.com/2020/10/31/BUH3i4.jpg" alt="图片替换文本" width="350" height="450" />
    * 用户调用接口
        * 为用户提供与文件及目录有关的调用，如新建、打开、读写、关闭、删除文件，建立和删除目录
        * 由若干程序模块组成，一个模块对应一个系统调用
    * 文件目录系统
        * 管理文件目录
            * 活跃文件目录表
            * 读写状态信息表
            * 用户进程的打开文件表
            * 存储设备上的文件目录结构
            * 调用下一级存取控制模块
    * 存取控制验证模块
        * 实现文件保护
            * 把访问请求和FCB进行比较
    * 逻辑文件系统和文件信息缓冲区
        * 根据文件的逻辑结构将用户要读写的逻辑记录转换为文件逻辑机构内的相应块号
    * 物理文件系统
        * 将逻辑相对块号转换为实际的物理块号
    * 辅助分配系统
        * 管理辅存空间
            * 分配辅存空闲空间和回收辅存空间
    * 设备管理控制模块
        * 分配设备、分配设备读写缓冲区、磁盘调度、启动设备处理涉笔中断、释放设备读写缓冲区，释放设备
* 文件实现
    * 关注两个问题
        * 文件的分配方式
            * 对磁盘非空闲块的管理
        * 文件存储空间的分配方式
            * 对磁盘空闲块的管理
    * 文件分配方式
        * 文件的物理结构，如何为文件分配磁盘块？
        * 三种方式（有的系统兼有，大部分只用一种）
            * 连续分配
                * 类比线性表的顺序存储
                * 支持顺序访问和直接访问
                * 评价
                    * 实现简单，存取速度快
                    * 但是文件长度不适动态增加，增加需要移动大量的磁盘块，反复删减会产生外部碎片
                    * 只适合长度固定的文件
            * 链接分配
                * 类比于线性表中的链表
                * 采取离散分配
                * 评价
                    * 消除了外部碎片
                    * 显著提高了磁盘空间的利用率
                    * 可以根据当前的文件需求为文件分配必要的盘块，支持动态增删，无需事先知道文件大小
                * 分类
                    * 隐式链接
                        * 每个文件对应一个磁盘块的链表，除了最后一个磁盘块，每个磁盘块都有指向下一个盘块的指针，且对用户透明
                        * 创建文件时，目录新增一个新条目，指向文件首块的指针。指针初始化为NULL表示空文件，大小字段为0。
                        * 评价
                            * 只能通过指针顺序访问文件，无法随机存取
                            * 盘块指针会消耗一定的存储空间
                            * 若是指针丢失或损坏，会导致文件数据的丢失
                    * 显式链接
                        * 将链接显式的存放在内存的一张链接表中，该表在整个磁盘中仅设置一张，称为**文件分配表FAT**
                        * 每个表项存放对应块的下一块的链接指针，即下一块的盘块号
                        * 图解显式链接
                        ![img](https://s1.ax1x.com/2020/10/31/BUXfPO.jpg)
                            * 所有的文件共用一张文件分配表FAT
                            * -1表示文件的最后一块，-2表示磁盘块空闲，所以操作系统还可以通过FAT进行文件存储管理
                            * FAT在系统启动时就会读入内存，因此查找FAT的过程是在内存中进行的，不仅显著地提高了检索速度，而起而明显减少了访问磁盘的次数
            * 索引分配
                * 链接分配解决了外部碎片和文件大小管理的问题，但除了FAT都之外，不支持直接访问，故产生索引分配
                * 索引分配：把一个文件的所有盘块号集中放在一起构成了索引块（索引表）
                * 每个文件都有其索引快，这是一个磁盘块地址的数组。索引块的第i个条目指向文件的第i个块。目录条目包括索引块的地址。要读第i块，通过索引块的第i个条目的指针来查找和读入所需的块
                * 评价
                    * 支持直接访问，没有外部碎片
                    * 需要解决的问题的索引块的大小
                        * 太大增加系统存储空间的开销
                        * 太小无法支持大文件
                * 索引块大小的解决办法
                    * 链接方案
                    * 多层索引
                    * 混合索引
    * 文件存储空间管理

## 两级页表
### 知识点背诵
* 为什么引入两级页表？
    * 引入分页管理后，进程执行时不用将所有的页调入内存，但是要把页表调入内存，所以需要考虑页表的大小
* 顶级页表最多有一个页面（规定）
* 构造一个二级页表（32位逻辑地址空间，页面大小为4KB，页表项大小为4B，以字节为编址单位）
    * 一个页面可以存放4KB/4B = 2<sup>10</sup>个页表项，占地址位数10位
    * 页面大小为4KB，则页内偏移量为12位

* 建立多级页表的目的在于建立索引，以便不用浪费主存空间去存储无用的页表项，也不用盲目地顺序式查找页表项