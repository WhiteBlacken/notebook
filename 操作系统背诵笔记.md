# 操作系统背诵笔记
## 内存管理

## 输入/输出管理
### I/O管理概述
#### 设备分类
* 按使用特性分类
    * 人机交互类外部设备
    * 存储设备
    * 网络通信设备
* 按传输速率分类
    * 低速设备
    * 中速设备
    * 高速设备
* 按信息交换的单位分类
    * 块设备
        * 以数据块为单位，有结构设备
        * 传输速率高，可寻址（即可随机读写）
    * 字符设备
        * 传输的基本单位是字符，无结构设备
        * 如交互式终端机，打印机
        * 传输速率低，不可寻址
        * 常采用中断驱动方式进行输入/输出
#### I/O控制方式
* 程序直接控制方式
    * 采用CPU轮询方式，未采用中断，CPU与I/O设备串行工作
* 中断驱动方式
    * 每个指令执行周期末尾，检查中断请求
    * 比程序直接控制有效，但数据的每个字在存储器和I/O设备之间的传输都必须经过CPU，仍未解放CPU
* DMA方式
    * 建立设备和内存的直接关系，解放CPU
    * 基本单位是数据块
    * 仅在预处理和后处理时需要CPU参与，传送阶段完全由DMA控制器（硬件）实现
    * 涉及到的寄存器
        * 命令/状态寄存器CR
            * 接收CPU发来的I/O命令和相关控制信息或设备的状态
        * 内存地址寄存器MAR
            * 输入时，记录内存的起始地址
            * 输出时，记录设备内存的起始地址
        * 数据寄存器DR
            * 暂存数据（双向）
        * 数据计数器DC
            * 存放本次要传输的字节数
* 通道方式
    * DMA方式的发展，进一步减少了CPU干预，把对一个数据块的读（写）为单位的干预，减少为对一组数据块的读（写）及相关控制和管理为单位的干预，实现CPU、通道、I/O设备三者的并行操作
    * 当CPU想要完成一组相关的读/写操作及有关控制，只需向I/O通道发送一条I/O指令，并给出通道程序的首地址和要访问的I/O设备，通道即可执行指定任务，结束时向CPU发送中断请求
    * I/O通道 vs 处理机
        * 通道指令类型单一，无自己内存，与CPU共享内存
    * I/O通道 vs DMA方式
        * DMA方式需要CPU来控制传输数据块的大小，传输的内存为止；而通道自己控制
        * 每个DMA控制器对应一台设备和内存传递数据；一个通道可以控制多台设备与内存的数据交换
#### I/O子系统的层次结构
* 用户层I/O软件
    * 通过系统调用获取操作系统服务
* 设备独立性（无关性）软件
    * 使应用程序独立于具体使用的物理设备；为实现设备独立性，引入了逻辑设备和物理设备两个概念
        * 应用程序使用逻辑设备来请求使用
        * 系统实际执行，将逻辑设备映射为物理设备名使用
        * 引入逻辑设备的好处
            * 增加设备分配的灵活性
            * 易于I/O重定向，即用于I/O的设备可以更换，而不必改变应用程序
    * 主要功能
        * 执行所有设备的公有操作
            * 设备的分配与回收
            * 逻辑设备名映射成物理设备名
            * 对设备进行保护，禁止用户直接访问设备
            * 缓冲管理
            * 差错控制
            * 提供独立于设备的大小统一的逻辑块，屏蔽设备之间信息交换单位的大小和传输速度的差异
        * 向用户层（或文件层）提供统一接口
            * 无论何种设备，他们向用户提供的接口都是想相同的。write/read等
    * 实现用户程序与设备驱动器的统一接口、设备命令、设备保护及设备的分配和释放等，同时为设备管理和数据传输提供必要的存储空间
* 设备驱动程序
    * 与硬件直接相关，负责具体实现呢系统对设备发出的操作指令，驱动I/O设备工作的驱动程序
    * 每类设备配置一个设备驱动器
    * 设备的具体差别被设备驱动程序所封装
        * 接收上层软件发来的抽象I/O要求，转换为具体要求，发给设备控制器
        * 也将设备控制器发来的信息传送给上层软件，隐藏设备控制器之间的差异
* 中断处理程序
        * 保存CPU现场，转入中断处理程序
        * 与硬件连续紧密，对用户而言，应该加以屏蔽
* 硬件设备
    * 电子部件
        * 设备控制器（适配器）
            * 通常是一块插入主板扩充槽的印制电路板
            * 主要功能
                * 接收和识别CPU或通道发来的指令
                * 实现数据交换
                * 发现和记录设备及自身的状态信息，供CPU使用
                * 设备地址是被
            * 组成部分
                * 设备控制器与CPU的接口
                    * 包含三类信号线
                    * 其中数据线通常与两类寄存器相联
                        * 数据寄存器
                        * 控制/状态寄存器
                * 设备控制器与设备的接口
                    * 三接口
                * I/O控制逻辑
                        
    * 机械部件
        * 设备本身
    >设备驱动器和CPU通信，通过寄存器（I/O端口）  
    其编址可以采用统一编址（内存映象I/O）或者独立编址

### I/O核心子系统
* 为平衡设备的种类，功能和传输速率的巨大差异，使用多种方法进行设备控制，这些方法共同构成了I/O子系统；将内核的其他方面从繁重的I/O操作中解放出来。
* 提供的服务有
    * I/O调度
    * 缓冲与高速缓存
    * 设备的分配与回收
    * 假脱机
    * 设备保护与差错处理
#### I/O调度概念
* 确定一个好的顺序来执行这些I/O请求（Q:中断判优？）
* 选择合理顺序，改善系统整体西能，使进程间公平地共享设备访问，减少I/O完成所需要的平均等待时间
* 操作系统的开发人员为每个设备维护一个请求队列来实现调度
* 磁盘调度算法是I/O调度的一种
#### 高速缓存和缓冲区 danger
* 磁盘高速缓存（disk cache）
    * 磁盘与内存中盘块在这里的关系类比于内存和Cache
    * 磁盘高速缓存，逻辑上属于磁盘，物理上是驻留在内存中盘块（空间换时间）
    * 两种形式
        * 内存中开辟单独的存储空间，大小固定
        * 把未利用的内存空间作为缓冲池，供请求分页系统和磁盘I/O共享
* 缓冲区（Buffer）
    * 引入缓冲区的目的
        * 缓和CPU与I/O速度不匹配
        * 解决基本数据单元大小不匹配（数据粒度）不匹配
        * 减少对CPU的中断频率，放宽对CPU响应时间的限制
        * 提高CPU与I/O设备的并行性
    * 实现方法
        * 硬件缓冲器
            * 成本高，非必要，不使用
        * 采用缓冲区（在内存中）
            * 特点：非空不能写，非满不能读
            * 根据使用的缓冲区器的个数，可以进行分类
                * 单缓冲
                * 双缓冲
                * 循环缓冲
                * 缓冲池
***